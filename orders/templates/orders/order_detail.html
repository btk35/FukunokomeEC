{% extends 'base.html' %}
{% load humanize %}
{% block title %}注文詳細入力 | ふくのこめ{% endblock %}
{% block main_content %}

<div class="container-sm my-5 mx-auto">
    <h2 class="mb-4">注文詳細入力</h2>
    
    <!-- ステップ表示 -->
    <div class="mb-4">
        <ul class="nav nav-pills nav-justified">
            <li class="nav-item"><span class="nav-link active">1.請求内容確認と詳細入力</span></li>
            <li class="nav-item"><span class="nav-link disabled">2. 確認</span></li>
            <li class="nav-item"><span class="nav-link disabled">3. 完了</span></li>
        </ul>
    </div>
    
    <form method="post" action="{% url 'orders:order_detail' %}">
        {% csrf_token %}
        
        <!-- 商品リスト -->
        <h3 class="mb-3">ご注文内容</h3>
        {% for item in cart_items %}
        <div class="card mb-3">
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-4">商品名</dt>
                    <dd class="col-sm-8">{{ item.product.brand }}｜{{ item.product.weight }}kg｜{{ item.product.is_milled|yesno:"白米,玄米" }}</dd>
                    
                    <dt class="col-sm-4">パッケージ単価</dt>
                    <dd class="col-sm-8">{{ item.product.total_price|floatformat:0 | intcomma }}円</dd>
                    
                    <dt class="col-sm-4">数量</dt>
                    <dd class="col-sm-8">{{ item.quantity }}袋</dd>
                    
                    <dt class="col-sm-4">小計（税抜）</dt>
                    <dd class="col-sm-8">{{ item.subtotal|floatformat:0 | intcomma }}円</dd>
                </dl>
            </div>
        </div>
        {% endfor %}
        
        <!-- 送料 -->
        <h3 class="mt-5 mb-3">送料</h3>
        <dl class="row">
            <dt class="col-sm-4">配送重量合計</dt>
            <dd class="col-sm-8">{{ total_weight }}kg</dd>
            <dt class="col-sm-4">送料（税抜）</dt>
            <dd class="col-sm-8">{{ shipping_fee|floatformat:0 | intcomma }}円</dd>
        </dl>
        <p class="text-danger small mb-0">税抜10,000円以上のお買上で送料無料となります。    </p>
        
        <!-- 合計 -->
        <h3 class="mt-5 mb-3">お支払い金額</h3>
        <dl class="row">
            <dt class="col-sm-4">税抜金額（軽減税率対象）</dt>
            <dd class="col-sm-8">{{ tax_detail.exempt|floatformat:0 | intcomma }}円</dd>
            
            <dt class="col-sm-4">税抜金額（通常税率）</dt>
            <dd class="col-sm-8">{{ tax_detail.taxable|floatformat:0 | intcomma }}円</dd>
            
            <dt class="col-sm-4">消費税額（軽減税率）</dt>
            <dd class="col-sm-8">{{ tax_detail.tax_exempt|floatformat:0 | intcomma }}円</dd>
            
            <dt class="col-sm-4">消費税額（通常税率）</dt>
            <dd class="col-sm-8">{{ tax_detail.tax_general|floatformat:0 }}円</dd>
            
            <dt class="col-sm-4 font-weight-bold">今回のご請求金額</dt>
            <dd class="col-sm-8 font-weight-bold text-danger h5">{{ total_price|floatformat:0 | intcomma }}円</dd>
        </dl>
        
        <h3 class="mb-3 mt-5">お届け先を選択</h3>
        
        <!-- 基本住所だけある場合 -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="shipping_choice" id="use_profile" value="profile"
                    {% if form.shipping_choice.value == "profile" or not is_shipping_registered %}checked{% endif %}>
                    <label class="form-check-label" for="use_profile">
                        <strong>基本住所（請求先住所）</strong><br>
                        {{ profile.last_name }} {{ profile.first_name }}<br>
                        {{ profile.postal_code }}<br>
                        {{ profile.prefecture }}{{ profile.city }}{{ profile.address }}<br>
                        電話番号：{{ profile.phone_number }}<br>
                        <a href="{% url 'profiles:edit_profile' target='profile' %}?next={{ request.path }}"
                        class="btn btn-outline-secondary btn-sm mt-2">基本住所を編集</a>
                    </label>
                </div>
            </div>
        </div>
        
        {% if not is_shipping_registered %}
        <div class="mb-4">
            <a href="{% url 'profiles:edit_profile' 'shipping' %}?next={{ request.path }}"
            class="btn btn-outline-primary btn-sm">
            別の住所に発送する
        </a>
    </div>
    {% endif %}
    
    {% if is_shipping_registered %}
    <div class="card mb-3">
        <div class="card-body">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="shipping_choice" id="use_shipping" value="shipping"
                {% if form.shipping_choice.value == "shipping" %}checked{% endif %}>
                <label class="form-check-label" for="use_shipping">
                    <strong>配送先住所</strong><br>
                    {{ shipping.last_name }} {{ shipping.first_name }}<br>
                    {{ shipping.postal_code }}<br>
                    {{ shipping.prefecture }}{{ shipping.city }}{{ shipping.address }}<br>
                    電話番号：{{ shipping.phone_number }}<br>
                    <a href="{% url 'profiles:edit_profile' target='shipping' %}?next={{ request.path }}"
                    class="btn btn-outline-secondary btn-sm mt-2">配送先を編集</a>
                </label>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- お届け希望日 -->
    <div class="mb-4 mt-5 row align-items-center">
        <label for="{{ form.delivery_date.id_for_label }}" class="col-sm-3 col-form-label">
            {{ form.delivery_date.label }}
        </label>
        <div class="col-sm-6">
            {{ form.delivery_date }}
            <small class="form-text text-muted">お届け日は5日後から指定が可能です。</small>
        </div>
    </div>
    
    <!-- 支払い方法 -->
    <div class="mb-4 row align-items-center">
        <label for="{{ form.payment_method.id_for_label }}" class="col-sm-3 col-form-label">
            {{ form.payment_method.label }}
        </label>
        <div class="col-sm-6">
            {{ form.payment_method }}
        </div>
    </div>
    
    <!-- 同意確認 -->
    <div class="form-check mt-5">
        {{ form.agree }}
        <label class="form-check-label" for="{{ form.agree.id_for_label }}">
            {{ form.agree.label }}
        </label>
    </div>
    
    <!-- 確認画面へ -->
    <div class="text-end mt-5">
        <button type="submit" class="btn btn-primary">確認画面へ進む</button>
    </div>
    <div class="text-start mt-4">
        <a href="{% url 'cart:view_cart' %}" class="btn btn-outline-secondary">
            カートに戻る
        </a>
    </div>
</form> 
</div>

{% endblock %}
